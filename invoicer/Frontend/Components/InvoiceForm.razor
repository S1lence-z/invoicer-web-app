@using Application.DTOs
@using Application.Extensions
@using Application.ServiceInterfaces
@using Domain.Enums
@using Domain.Interfaces
@using Frontend.Models
@using Frontend.Services
@using Frontend.Utils
@using Microsoft.Extensions.Localization
@inject IInvoiceService invoiceService
@inject IEntityService entityService
@inject ErrorService errorService
@inject LoadingService loadingService
@inject IStringLocalizer<InvoiceForm> L

<EditForm Model="@invoiceFormModel" OnValidSubmit="SubmitForm">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="row mb-4">
        <div class="col">
            <div class="d-flex flex-row gap-4 align-items-end">
                <div class="d-flex flex-column">
                    <label for="invoice-number" class="font-weight-bold">@L["InvoiceNumberLabel"]</label>
                    <input type="text" class="form-control" id="invoice-number"
                    value="@((isFetchingNextInvoiceNumber ? L["LoadingMessage"] : invoiceFormModel.InvoiceNumber))"
                    @oninput="e => invoiceFormModel.InvoiceNumber = e.Value?.ToString()!"
                    disabled="@(!isCustomInvoiceNumber)" />
                </div>
                <button type="button" class="btn btn-outline-secondary align-self-end" @onclick="ToggleCustomInvoiceNumber">
                    @if (isCustomInvoiceNumber)
                    {
                        <span>@L["InvoiceNumberUseDefaultButton"]</span>
                    }
                    else
                    {
                        <span>@L["InvoiceNumberCustomizeButton"]</span>
                    }
                </button>
            </div>
            <ValidationMessage For="@(() => invoiceFormModel.InvoiceNumber)" />
        </div>
    </div>

    <div class="row mb-4">
        <div class="col">
            <label for="issue-date" class="font-weight-bold">@L["IssueDateLabel"]</label>
            <input type="date" class="form-control" id="issue-date" @bind="invoiceFormModel.IssueDate" />
            <ValidationMessage For="@(() => invoiceFormModel.IssueDate)" />
        </div>
        <div class="col">
            <label for="due-date" class="font-weight-bold">@L["DueDateLabel"]</label>
            <input type="date" class="form-control" id="due-date" @bind="invoiceFormModel.DueDate" />
            <ValidationMessage For="@(() => invoiceFormModel.DueDate)" />
        </div>
        <div class="col">
            <label for="vate-date" class="font-weight-bold">@L["VatDateLabel"]</label>
            <input type="date" class="form-control" id="vat-date" @bind="invoiceFormModel.VatDate" />
            <ValidationMessage For="@(() => invoiceFormModel.VatDate)" />
        </div>
    </div>

    <div class="row mb-4">
        <div class="col">
            <label for="seller" class="font-weight-bold">@L["SellerLabel"]</label>
            <select class="form-control" id="seller" @bind="invoiceFormModel.SellerId" @bind:after="OnChosenSellerChangedAfterBind" disabled="@(InvoiceInstance is not null)">
                <option value="0">@L["SellerSelectOption"]</option>
                @foreach (var entity in allEntities)
                {
                    <option value="@entity.Id">@entity.Name</option>
                }
            </select>
            <ValidationMessage For="@(() => invoiceFormModel.SellerId)" />
        </div>
        <div class="col">
            <label for="buyer" class="font-weight-bold">@L["BuyerLabel"]</label>
            <select class="form-control" id="buyer" @bind="invoiceFormModel.BuyerId">
                <option value="0">@L["BuyerSelectOption"]</option>
                @foreach (var entity in allBuyers)
                {
                    <option value="@entity.Id">@entity.Name</option>
                }
            </select>
            <ValidationMessage For="@(() => invoiceFormModel.BuyerId)" />
        </div>
    </div>

    <div class="row mb-4">
        <div class="col">
            <label for="currency" class="font-weight-bold">@L["CurrencyLabel"]</label>
            <select class="form-control" id="currency" @bind="invoiceFormModel.Currency">
                @foreach (Currency value in Enum.GetValues(typeof(Currency)))
                {
                    <option value="@value">@value</option>
                }
            </select>
            <ValidationMessage For="@(() => invoiceFormModel.Currency)" />
        </div>
        <div class="col">
            <label for="payment-method" class="font-weight-bold">@L["PaymentMethodLabel"]</label>
            <select class="form-control" id="payment-method" @bind="invoiceFormModel.PaymentMethod">
                @foreach (PaymentMethod value in Enum.GetValues(typeof(PaymentMethod)))
                {
                    <option value="@value">@value.ToString()!.SeperateCamelCase()</option>
                }
            </select>
            <ValidationMessage For="@(() => invoiceFormModel.PaymentMethod)" />
        </div>
        <div class="col">
            <label for="delivery-method" class="font-weight-bold">@L["DeliveryMethodLabel"]</label>
            <select class="form-control" id="delivery-method" @bind="invoiceFormModel.DeliveryMethod">
                @foreach (DeliveryMethod value in Enum.GetValues(typeof(DeliveryMethod)))
                {
                    <option value="@value">@value.ToString()!.SeperateCamelCase()</option>
                }
            </select>
            <ValidationMessage For="@(() => invoiceFormModel.DeliveryMethod)" />
        </div>
    </div>

    <div class="row mb-4">
        <div class="col">
            <label for="status" class="font-weight-bold">@L["StatusLabel"]</label>
            <select class="form-control" id="status" @bind="invoiceFormModel.Status">
                @foreach (InvoiceStatus value in Enum.GetValues(typeof(InvoiceStatus)))
                {
                    <option value="@value">@value.ToString()!.SeperateCamelCase()</option>
                }
            </select>
            <ValidationMessage For="@(() => invoiceFormModel.Status)" />
        </div>
    </div>

    <hr class="my-4" />
    <h4>@L["InvoiceItemsHeader"]</h4>
    @if (!invoiceFormModel.Items.Any())
    {
        <p class="text-muted">@L["NoItemsAddedMessage"]</p>
        <ValidationMessage For="@(() => invoiceFormModel.Items)" />
    }
    @foreach (var item in invoiceFormModel.Items)
    {
        var itemUniqueSuffix = item.GetHashCode();
        <div class="row g-2 mb-3 pb-3 border-bottom align-items-start">
            <div class="col-md-4">
                <label for="item-description-@itemUniqueSuffix" class="form-label small">@L["ItemDescriptionLabel"]</label>
                <input id="item-description-@itemUniqueSuffix" type="text" class="form-control form-control-sm" placeholder="@L["ItemDescriptionPlaceholder"]" @bind="item.Description" />
                <ValidationMessage For="@(() => item.Description)" />
            </div>
            <div class="col-md-1 col-6">
                <label for="item-quantity-@itemUniqueSuffix" class="form-label small">@L["ItemQuantityLabel"]</label>
                <input id="item-quantity-@itemUniqueSuffix" type="number" min="1" class="form-control form-control-sm" placeholder="@L["ItemQuantityPlaceholder"]" @bind="item.Quantity" />
                <ValidationMessage For="@(() => item.Quantity)" />
            </div>
            <div class="col-md-2 col-6">
                <label for="item-unit-@itemUniqueSuffix" class="form-label small">@L["ItemUnitLabel"]</label>
                <input id="item-unit-@itemUniqueSuffix" type="text" class="form-control form-control-sm" placeholder="@L["ItemUnitPlaceholder"]" @bind="item.Unit" />
                <ValidationMessage For="@(() => item.Unit)" />
            </div>
            <div class="col-md-2">
                <label for="item-unit-price-@itemUniqueSuffix" class="form-label small">@L["ItemUnitPriceLabel"]</label>
                <input id="item-unit-price-@itemUniqueSuffix" type="number" min="0" step="any" class="form-control form-control-sm" placeholder="@L["ItemUnitPricePlaceholder"]" @bind="item.UnitPrice" />
                <ValidationMessage For="@(() => item.UnitPrice)" />
            </div>
            <div class="col-md-2">
                <label for="item-vat-rate-@itemUniqueSuffix" class="form-label small">@L["ItemVatRateLabel"]</label>
                <input id="item-vat-rate-@itemUniqueSuffix" type="number" min="0" class="form-control form-control-sm" @bind="item.VatRate" step="0.01" />
                <ValidationMessage For="@(() => item.VatRate)" />
                <div class="btn-group btn-group-sm mt-1" role="group" aria-label="@L["VatPresetAriaLabel"]">
                    <button type="button" class="btn btn-outline-secondary" @onclick="() => SetVatRate(item, 0)">0 %</button>
                    <button type="button" class="btn btn-outline-secondary" @onclick="() => SetVatRate(item, 15)">15 %</button>
                    <button type="button" class="btn btn-outline-secondary" @onclick="() => SetVatRate(item, 18)">18 %</button>
                    <button type="button" class="btn btn-outline-secondary" @onclick="() => SetVatRate(item, 21)">21 %</button>
                </div>
            </div>
            <div class="col-md-1 text-end">
                <label class="form-label small d-block invisible">@L["RemoveItemButtonTitle"]</label>
                <button type="button" title="@L["RemoveItemButtonTitle"]" class="btn btn-danger btn-sm" @onclick="() => RemoveInvoiceItem(item)">
                    @L["RemoveItemButtonText"]
                </button>
            </div>
        </div>
    }
    <button type="button" class="btn btn-success float-start" @onclick="AddInvoiceItem">
        @L["AddItemButtonText"]
    </button>
    <button type="submit" class="btn btn-primary float-end">@L["SubmitInvoiceButtonText"]</button>
</EditForm>

@code {
    // Parameters
    [Parameter] public EventCallback SubmitCallback { get; set; }
    [Parameter] public InvoiceDto? InvoiceInstance { get; set; } = null;
    [Parameter, EditorRequired] public bool isActive { get; set; }

    // Form Models
    private InvoiceFormModel invoiceFormModel { get; set; } = new();
    private IList<EntityDto> allEntities = new List<EntityDto>();
    private IList<EntityDto> allBuyers = new List<EntityDto>();

    // Variables
    private bool isCustomInvoiceNumber = false;
    private bool isFetchingNextInvoiceNumber = false;
    private string defaultFetchedInvoiceNumber = string.Empty;

    // Constants
    private const string LOADING_MESSAGE = "Loading...";

    // Methods
    protected override void OnParametersSet()
    {
        if (InvoiceInstance is not null)
        {
            invoiceFormModel = InvoiceFormModel.FromInvoice(InvoiceInstance);
            defaultFetchedInvoiceNumber = InvoiceInstance.InvoiceNumber;
        }
        if (!isActive)
            ResetForm();
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            allEntities = await entityService.GetAllAsync();
            allBuyers = allEntities.Where(e => e.Id != invoiceFormModel.SellerId).ToList();
        }
        catch (Exception e)
        {
            errorService.ShowError(e.Message);
        }
    }

    private void ToggleCustomInvoiceNumber()
    {
        isCustomInvoiceNumber = !isCustomInvoiceNumber;
        invoiceFormModel.IsCustomInvoiceNumber = isCustomInvoiceNumber;
        if (!isCustomInvoiceNumber)
            invoiceFormModel.InvoiceNumber = defaultFetchedInvoiceNumber;
    }

    private async Task SubmitForm() {
        loadingService.StartLoading();
        try 
        {
            if (InvoiceInstance is null)
                await SubmitNewInvoice();
            else
                await SubmitEditInvoice();
            await SubmitCallback.InvokeAsync();
            ResetForm();
        } 
        catch (Exception e) 
        {
            errorService.ShowError(e.Message);
        }
        finally 
        {
            loadingService.StopLoading();
        }
    }

    private async Task SubmitNewInvoice() 
    {
        InvoiceDto newInvoice = new()
            {
                InvoiceNumber = invoiceFormModel.InvoiceNumber,
                IsCustomInvoiceNumber = invoiceFormModel.IsCustomInvoiceNumber,
                IssueDate = invoiceFormModel.IssueDate,
                DueDate = invoiceFormModel.DueDate,
                VatDate = invoiceFormModel.VatDate,
                Status = invoiceFormModel.Status,
                SellerId = invoiceFormModel.SellerId,
                BuyerId = invoiceFormModel.BuyerId,
                Currency = invoiceFormModel.Currency,
                PaymentMethod = invoiceFormModel.PaymentMethod,
                DeliveryMethod = invoiceFormModel.DeliveryMethod,
                Items = invoiceFormModel.Items.Select(InvoiceItemFormModel.ToInvoiceItem).ToList()

            };
        InvoiceDto createdInvoice = await invoiceService.CreateAsync(newInvoice);
    }

    private async Task SubmitEditInvoice()
    {
        if (InvoiceInstance is null)
            return;
        InvoiceDto editedInvoice = InvoiceInstance with
        {
            InvoiceNumber = invoiceFormModel.InvoiceNumber,
            IsCustomInvoiceNumber = invoiceFormModel.IsCustomInvoiceNumber,
            IssueDate = invoiceFormModel.IssueDate,
            DueDate = invoiceFormModel.DueDate,
            VatDate = invoiceFormModel.VatDate,
            Status = invoiceFormModel.Status,
            SellerId = invoiceFormModel.SellerId,
            BuyerId = invoiceFormModel.BuyerId,
            Currency = invoiceFormModel.Currency,
            PaymentMethod = invoiceFormModel.PaymentMethod,
            DeliveryMethod = invoiceFormModel.DeliveryMethod,
            Items = invoiceFormModel.Items.Select(InvoiceItemFormModel.ToInvoiceItem).ToList()
        };
        InvoiceDto updatedInvoice = await invoiceService.UpdateAsync(editedInvoice.Id, editedInvoice);
    }

    private void ResetForm()
    {
        isCustomInvoiceNumber = false;
        defaultFetchedInvoiceNumber = string.Empty;
        invoiceFormModel = new();
    }

    private void AddInvoiceItem()
    {
        invoiceFormModel.Items.Add(new());
    }

    private void RemoveInvoiceItem(InvoiceItemFormModel item)
    {
        invoiceFormModel.Items.Remove(item);
    }

    private async Task OnChosenSellerChangedAfterBind()
    {
        int sellerId = invoiceFormModel.SellerId;
        InvoiceDto? newInvoice = await GetNewOrUpdatedInvoiceInitialData(sellerId);
        if (newInvoice is null)
            return;
        defaultFetchedInvoiceNumber = newInvoice.InvoiceNumber;
        invoiceFormModel.InvoiceNumber = defaultFetchedInvoiceNumber;
        UpdateBuyers(sellerId);
    }

    private void UpdateBuyers(int newSellerId)
    {
        // Store the buyer ID that was selected *before* this seller change.
        int buyerIdBeforeSellerChange = invoiceFormModel.BuyerId;

        // Update the list of available buyers for the dropdown, excluding the new seller.
        allBuyers = allEntities
            .Where(e => e.Id != newSellerId)
            .ToList();

        if (buyerIdBeforeSellerChange == 0)
            invoiceFormModel.BuyerId = 0;
        else if (buyerIdBeforeSellerChange == newSellerId || !allBuyers.Any(b => b.Id == buyerIdBeforeSellerChange))
            invoiceFormModel.BuyerId = allBuyers.FirstOrDefault()?.Id ?? 0;
    }

    private async Task<InvoiceDto?> GetNewOrUpdatedInvoiceInitialData(int sellerId)
    {
        if (sellerId == 0) return null;
        isFetchingNextInvoiceNumber = true;
        try
        {
            InvoiceDto newInvoice = await invoiceService.GetNewInvoiceInformationAsync(sellerId);
            return newInvoice;
        }
        catch (Exception ex)
        {
            errorService.ShowError(ex.Message);
            return null;
        }
        finally
        {
            isFetchingNextInvoiceNumber = false;
        }
    }

    private void SetVatRate(InvoiceItemFormModel item, decimal ratePercentage)
    {
        item.VatRate = ratePercentage / 100.0m;
    }
}
